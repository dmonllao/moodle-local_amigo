define(["jquery","core/config","core/url","core/ajax","local_amigo/idle","core/notification","local_amigo/aes","local_amigo/core"],function(a,b,c,d,e,f,g,h){var i=1e3,j=7e3,k="localamigo",l=function(b,c,d,g,h){if(this.pokes=b,this.config=c,this.timeInfo=d,this.user=g,this.site=h,this.idle=new e,!(this.pokes.length<1)){if(!("Notification"in window))return void window.console.log("This browser does not support desktop notification");if("denied"!==Notification.permission){this.currentView.pageId=a("body").attr("id");for(var j=this.pokes.length;j--;)if("undefined"!=typeof this.pokes[j].getTargetPages){var k=this.pokes[j].getTargetPages(),l=!1;for(var m in k){var n=new RegExp(k[m]);if(this.currentView.pageId.match(n)){l=!0;break}}0==l&&this.pokes.splice(j,1)}for(var j in this.pokes)this.callbacks.push(this.pokes[j].getCallback());this.timeTracker=setInterval(this.trackActive.bind(this),i),"granted"!==Notification.permission&&Notification.requestPermission().then(function(a){"granted"===a&&1!=this.user.introshowed&&this.sendNotification("Hi from Chuck","Hello, I am your personal moodle-amigo."),this.done()}.bind(this).fail(f.exception)),this.previousViews=this.getPreviousViews(),window.console.log(this.previousViews)}}};return l.prototype.config={},l.prototype.timeInfo={},l.prototype.user={},l.prototype.site={},l.prototype.idle=!1,l.prototype.pokes=[],l.prototype.callbacks=[],l.prototype.currentView={pageId:null,counterActive:0,counterLastActive:0,counterInactive:0,counterLastInactive:0,counterIdle:0},l.prototype.previousViews=[],l.prototype.lastState=null,l.prototype.notification=null,l.prototype.timeTracker=null,l.prototype.trackActive=function(){if("granted"!==Notification.permission)return void this.done();var a=document.hasFocus(),b=this.idle.isIdle();a?(this.currentView.counterActive++,this.currentView.counterLastActive++):(this.currentView.counterInactive++,this.currentView.counterLastInactive++),b?this.currentView.counterIdle++:this.currentView.counterIdle=0,window.console.log("Active: "+this.currentView.counterActive+" Active last: "+this.currentView.counterLastActive+" Inactive: "+this.currentView.counterInactive+" Inactive last: "+this.currentView.counterLastInactive+" Idle: "+this.currentView.counterIdle);for(var c in this.callbacks){var d=this.callbacks[c](this.currentView,a,b);if(d)return this.sendNotification(d[0],d[1],d[2],d[3]),d[2]&&this.storeLastPoke(d[2]),void this.done()}a===!0&&this.lastState===!1?this.currentView.counterLastActive=0:a===!1&&this.lastState===!0&&(this.currentView.counterLastInactive=0),this.lastState=a,this.storeSessionViews()},l.prototype.done=function(){clearInterval(this.timeTracker)},l.prototype.sendNotification=function(a,b,d,e){"undefined"==typeof b&&(b=""),this.notification&&"function"==typeof this.notification.close&&this.notification.close(),this.notification=new Notification(a,{icon:c.relativeUrl("local/amigo/pix/chuck.jpg"),body:b}),this.notification.onclick=function(a){a.preventDefault(),e&&e.bind(this)(),this.notification.close()}.bind(this),setTimeout(this.notification.close.bind(this.notification),j)},l.prototype.storeLastPoke=function(a){var b=new Date;d.call([{methodname:"core_user_set_user_preferences",args:{preferences:[{name:"local_amigo_last_poke_"+a,value:Math.round(b.getTime()/1e3),userid:this.user.id}]},fail:f.exception}])},l.prototype.getPreviousViews=function(){var a=sessionStorage.getItem(k+"views");if(a){var c=g.decrypt(a,b.sesskey);try{return JSON.parse(c.toString(h.enc.Utf8))}catch(d){sessionStorage.removeItem(k+"views")}}return[]},l.prototype.storeSessionViews=function(){var a=JSON.stringify([this.currentView].concat(this.previousViews));sessionStorage.setItem(k+"views",g.encrypt(a,b.sesskey).toString())},{init:function(b,c,d,e,f){var g=[],h=[];for(var i in b){var j="local_amigo/poke_"+i;g.push(a.Deferred()),require([j],function(a){h.push(new a(c,d,e,f)),g.pop().resolve(j)})}a.when.apply(a,g).then(function(){new l(h,c,d,e,f)})}}});